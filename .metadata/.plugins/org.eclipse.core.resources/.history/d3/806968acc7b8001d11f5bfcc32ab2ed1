/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2023 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>

// Base address for the System Handler Control and State Register (Configurable)
#define SHCSR (* (uint32_t volatile*) 0xE000ED24)

// Bit locations for the Faults exception enable

#define MEM 16					// MEM
#define USAGE 18				// USAGE

/** Since the HARD faults are always enabled, there's no need to configure it **/

/**
 * Addresses System Interrupt Configuration registers
 */

void enable_usage_fault(){
	SHCSR |= (1 << USAGE);
}

__attribute__((naked)) void trigger_usage(){
	// Set T bit in the control register
	__asm volatile("MRS R0, CONTROL");
	__asm volatile("ORR RO, R0, #0x01000000");
	__asm volatile("MSR CONTROL, R0");

	__asm volatile("MOV R0, #0x23");
	__asm volatile("RSC R0, R1, R2");
}

int main(void)
{
	// enable the usage fault
	enable_usage_fault();

	// trigger the usage fault
	trigger_usage();
    /* Loop forever */
	for(;;);
}

void UsageFault_Handler(){
	printf("In usage fault handler\n");
}
